{% extends "member/base.html" %}
{% block title %}ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°{% endblock %}
{% block content %}

<div class="auth-wrapper">
  <div class="auth-card auth-card--wide">
    <div>
      <p class="auth-card__subtitle">ì•ˆì „í•œ ë³‘ë™ ì¼€ì–´ íŒŒíŠ¸ë„ˆ</p>
      <h1 class="auth-card__title">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</h1>
    </div>
    <p class="text-muted">ì…ë ¥í•˜ì‹  ì •ë³´ë¥¼ í™•ì¸í•œ ë’¤ ì„ì‹œë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤.</p>

    <div id="error" class="alert alert-error" style="display: none"></div>
    <div id="result" class="alert alert-success" style="display: none"></div>

    <form id="find-password-form" method="POST" class="auth-form">
      {% csrf_token %}
      <div class="input-field">
        <label for="member_id">ì•„ì´ë””</label>
        <input
          type="text"
          id="member_id"
          name="member_id"
          class="input-control"
          placeholder="ì•„ì´ë””"
          required
        />
      </div>
      <div class="input-field">
        <label for="name">ì´ë¦„</label>
        <input type="text" id="name" name="name" class="input-control" placeholder="ì´ë¦„" required />
      </div>
      <div class="input-field">
        <label for="phone">ì „í™”ë²ˆí˜¸</label>
        <input
          type="text"
          id="phone"
          name="phone"
          class="input-control"
          placeholder="íœ´ëŒ€ì „í™” ë²ˆí˜¸ (- ì—†ì´ ì…ë ¥)"
          required
        />
      </div>
      <div class="input-field">
        <label for="code">ì¸ì¦ë²ˆí˜¸</label>
        <div class="input-inline">
          <input
            type="text"
            id="code"
            name="code"
            class="input-control"
            placeholder="ì¸ì¦ë²ˆí˜¸"
            required
          />
          <button type="button" id="send-code-btn" class="btn btn-outline">ì¸ì¦ë²ˆí˜¸ ë°›ê¸°</button>
        </div>
      </div>
      <button type="submit" class="btn btn-primary btn-block">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</button>
    </form>

    <div class="auth-links">
      <a href="{% url 'member_login' %}">ë¡œê·¸ì¸</a>
      <a href="{% url 'find_id' %}">ì•„ì´ë”” ì°¾ê¸°</a>
      <a href="{% url 'member_reg' %}">íšŒì›ê°€ì…</a>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const pwdForm = document.getElementById("find-password-form");
  const pwdSendBtn = document.getElementById("send-code-btn");
  const pwdError = document.getElementById("error");
  const pwdResult = document.getElementById("result");

  const toggleAlert = (el, text) => {
    if (!text) {
      el.style.display = "none";
      el.textContent = "";
      return;
    }
    el.textContent = text;
    el.style.display = "block";
  };

  const pwdCsrfToken = () => pwdForm.querySelector('input[name="csrfmiddlewaretoken"]').value;

  pwdSendBtn.addEventListener("click", function () {
    const phone = document.getElementById("phone").value.trim();
    if (!phone) {
      Swal.fire({ icon: "warning", text: "ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." });
      return;
    }

    fetch("{% url 'send_verification_code' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": pwdCsrfToken(),
      },
      body: "phone=" + encodeURIComponent(phone),
    })
      .then((res) => res.json())
      .then(() => {
        Swal.fire({ icon: "success", text: "ğŸ“© ì¸ì¦ë²ˆí˜¸ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!" });
      });
  });

  pwdForm.addEventListener("submit", function (e) {
    e.preventDefault();

    const member_id = pwdForm.member_id.value.trim();
    const name = pwdForm.name.value.trim();
    const phone = pwdForm.phone.value.trim();
    const code = pwdForm.code.value.trim();
    const params = new URLSearchParams({ member_id, name, phone, code });

    fetch("{% url 'find_password' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": pwdCsrfToken(),
      },
      body: params.toString(),
    })
      .then((res) => {
        if (!res.ok) throw res;
        return res.json();
      })
      .then((data) => {
        toggleAlert(pwdError, "");
        toggleAlert(pwdResult, `ë¹„ë°€ë²ˆí˜¸ëŠ” "${data.passwd}" ì…ë‹ˆë‹¤.`);
      })
      .catch(async (err) => {
        const errData = await err.json();
        toggleAlert(pwdError, "âŒ " + errData.error);
        toggleAlert(pwdResult, "");
      });
  });
</script>

{% endblock %}
