{% extends "member/base.html" %}
{% block title %}낙상기록 조회{% endblock %}
{% block content %}
<style>
  .record-dashboard {
    display: flex;
    flex-direction: column;
    gap: 32px;
  }

  .dashboard-headline h2 {
    margin: 0 0 8px;
    font-size: 1.8rem;
    letter-spacing: -0.02em;
  }

  .dashboard-headline p {
    margin: 0;
    color: var(--text-muted);
    font-size: 0.95rem;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
  }

  .stat-card {
    padding: 20px;
    border-radius: 20px;
    background: #f8f9ff;
    border: 1px solid var(--border-light);
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .stat-card span {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .stat-card strong {
    font-size: 1.8rem;
    font-weight: 700;
  }

  .stat-card small {
    color: var(--text-muted);
    font-size: 0.85rem;
  }

  .stat-critical {
    background: linear-gradient(135deg, #ffe8ec, #ffd5dd);
    border-color: #ffc1c9;
    color: #b7002c;
  }

  .stat-warning {
    background: linear-gradient(135deg, #fff6da, #ffeeba);
    border-color: #ffe3a3;
    color: #a57300;
  }

  .stat-safe {
    background: linear-gradient(135deg, #e7fbff, #d1f4ff);
    border-color: #b9efff;
    color: #00728c;
  }

  .filter-card {
    padding: 20px;
    border-radius: 20px;
    background: var(--card-bg);
    border: 1px solid var(--border-light);
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .filter-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
  }

  .filter-form label {
    display: flex;
    flex-direction: column;
    font-size: 0.85rem;
    color: var(--text-muted);
    gap: 6px;
  }

  .filter-form input,
  .filter-form select {
    border: 1px solid var(--border-light);
    border-radius: 12px;
    padding: 10px 12px;
    font-size: 0.95rem;
    font-family: inherit;
    background: #f7f8fc;
  }

  .filter-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .btn {
    border: none;
    border-radius: 999px;
    padding: 10px 18px;
    font-size: 0.95rem;
    cursor: pointer;
    transition: transform 0.1s ease, box-shadow 0.2s ease;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
    box-shadow: 0 12px 24px rgba(90, 110, 220, 0.3);
  }

  .btn-outline {
    background: transparent;
    color: var(--text-muted);
    border: 1px solid var(--border-light);
  }

  .btn:hover {
    transform: translateY(-1px);
  }

  .data-card {
    overflow: hidden;
    border-radius: 24px;
    border: 1px solid var(--border-light);
    background: var(--card-bg);
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
  }

  .data-table th {
    background: #f4f6fb;
    padding: 14px 12px;
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-muted);
    text-align: left;
  }

  .data-table td {
    padding: 14px 12px;
    border-bottom: 1px solid #f1f2f6;
    vertical-align: middle;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .badge-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    display: inline-block;
  }

  .badge-critical {
    background: #ffe3e8;
    color: #c2002f;
  }

  .badge-critical .badge-dot {
    background: #c2002f;
  }

  .badge-warning {
    background: #fff1d8;
    color: #a05d00;
  }

  .badge-warning .badge-dot {
    background: #ffa000;
  }

  .badge-safe {
    background: #e3f7ff;
    color: #006d87;
  }

  .badge-safe .badge-dot {
    background: #00a1c6;
  }

  .note-text {
    max-width: 260px;
    color: var(--text-muted);
    line-height: 1.4;
  }

  .delete-form button {
    background: #f25757;
    color: #fff;
    border: none;
    border-radius: 999px;
    padding: 6px 14px;
    font-size: 0.85rem;
    cursor: pointer;
  }

  .empty-row td {
    text-align: center;
    padding: 40px 12px;
    color: var(--text-muted);
  }

  .cta-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
  }

  .info-link {
    color: var(--accent);
    font-weight: 600;
    text-decoration: none;
  }

  .insight-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 16px;
  }

  .trend-card,
  .alert-card {
    border-radius: 20px;
    border: 1px solid var(--border-light);
    background: var(--card-bg);
    padding: 18px;
  }

  .trend-card h4,
  .alert-card h4 {
    margin: 0 0 12px;
    font-size: 1rem;
    color: var(--text-muted);
  }

  .trend-bars {
    display: flex;
    gap: 12px;
    align-items: flex-end;
    height: 120px;
  }

  .trend-bar {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .trend-bar__value {
    width: 40px;
    border-radius: 12px 12px 4px 4px;
    background: rgba(90, 110, 220, 0.2);
    backdrop-filter: blur(3px);
    height: calc(var(--bar-value, 0) * 18px);
    max-height: 120px;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    color: var(--accent);
    font-weight: 600;
    font-size: 0.85rem;
    padding-bottom: 6px;
  }

  .trend-bar__label {
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .alert-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .alert-item {
    padding: 12px 14px;
    border-radius: 16px;
    background: #f7f8fc;
    border: 1px solid var(--border-light);
  }

  .alert-item strong {
    display: block;
    margin-bottom: 4px;
    color: var(--text-dark);
  }

  .alert-item span {
    font-size: 0.85rem;
    color: var(--text-muted);
  }
</style>

<section class="page-card record-dashboard">
  <div class="dashboard-headline">
    <h2>낙상 이력 대시보드</h2>
    <p>
      최신 낙상 데이터를 한눈에 확인하고, 이름·기간·위험 단계 별로 빠르게 필터링하세요.
    </p>
  </div>

  <div class="insight-grid">
    <div class="trend-card">
      <h4>최근 7일 추세</h4>
      <div class="trend-bars">
        {% for day in summary.weekly_trend %}
        <div class="trend-bar">
          <div class="trend-bar__value" style="--bar-value: {{ day.count|default:0 }};">
            {{ day.count }}
          </div>
          <div class="trend-bar__label">{{ day.date }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
    <div class="alert-card">
      <h4>최근 알림</h4>
      <ul class="alert-list">
        {% for alert in recent_alerts %}
        <li class="alert-item">
          <strong>{{ alert.message }}</strong>
          <span>{{ alert.timestamp|date:"m.d H:i" }} · {{ alert.fall_level }} · {{ alert.room_number }}</span>
        </li>
        {% empty %}
        <li class="alert-item">
          <span>알림 이력이 없습니다.</span>
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <span>전체 기록</span>
      <strong>{{ summary.total }}</strong>
      <small>
        {% if summary.latest %}최근 {{ summary.latest.fall_date|date:"Y.m.d H:i" }} 업데이트
        {% else %}등록된 기록이 없습니다.{% endif %}
      </small>
    </div>
    <div class="stat-card stat-critical">
      <span>고위험</span>
      <strong>{{ summary.levels.critical }}</strong>
      <small>심각 단계</small>
    </div>
    <div class="stat-card stat-warning">
      <span>중간위험</span>
      <strong>{{ summary.levels.warning }}</strong>
      <small>중간 단계</small>
    </div>
    <div class="stat-card stat-safe">
      <span>경미</span>
      <strong>{{ summary.levels.safe }}</strong>
      <small>경미 단계</small>
    </div>
  </div>

  <div class="filter-card">
    <form method="GET" class="filter-form">
      <label>
        이름
        <input
          type="text"
          name="name"
          placeholder="환자명"
          value="{{ filters.name }}"
        />
      </label>
      <label>
        위험 단계
        <select name="level">
          <option value="">전체</option>
          <option value="심각" {% if filters.level == "심각" %}selected{% endif %}>심각</option>
          <option value="중간" {% if filters.level == "중간" %}selected{% endif %}>중간</option>
          <option value="경미" {% if filters.level == "경미" %}selected{% endif %}>경미</option>
        </select>
      </label>
      <label>
        시작일
        <input type="date" name="start_date" value="{{ filters.start_date }}" />
      </label>
      <label>
        종료일
        <input type="date" name="end_date" value="{{ filters.end_date }}" />
      </label>
      <div class="filter-actions">
        <button type="submit" class="btn btn-primary">검색</button>
        <a href="{% url 'fall_record_list' %}" class="btn btn-outline">필터 초기화</a>
        <a href="{% url 'fall_record_add' %}" class="btn btn-primary" style="background: #00a896">
          ➕ 새 기록 추가
        </a>
      </div>
    </form>
  </div>

  <div class="data-card">
    <table class="data-table">
      <thead>
        <tr>
          <th>이름</th>
          <th>나이</th>
          <th>병동/호실</th>
          <th>발생일</th>
          <th>위험 단계</th>
          <th>낙상 부위</th>
          <th>특이사항</th>
          <th>관리</th>
        </tr>
      </thead>
      <tbody>
        {% for record in records %}
        <tr>
          <td>{{ record.name }}</td>
          <td>{{ record.age }}</td>
          <td>{{ record.room_number }}</td>
          <td>{{ record.fall_date|date:"Y-m-d H:i" }}</td>
          <td>
            {% if record.fall_level == "심각" %}
            <span class="badge badge-critical">
              <span class="badge-dot"></span> 심각
            </span>
            {% elif record.fall_level == "중간" %}
            <span class="badge badge-warning">
              <span class="badge-dot"></span> 중간
            </span>
            {% else %}
            <span class="badge badge-safe">
              <span class="badge-dot"></span> 경미
            </span>
            {% endif %}
          </td>
          <td>{{ record.fall_area }}</td>
          <td class="note-text">{{ record.note|default:"-" }}</td>
          <td>
            <form
              method="POST"
              action="{% url 'fall_record_delete' record.record_id %}"
              class="delete-form"
            >
              {% csrf_token %}
              <button
                type="submit"
                onclick="return confirm('해당 낙상 기록을 삭제할까요?');"
              >
                삭제
              </button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr class="empty-row">
          <td colspan="8">조건에 맞는 낙상 기록이 없습니다.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="cta-row">
    <p>
      ※ 자세한 실시간 알림은
      <a class="info-link" href="{% url 'fall_alert_list' %}">알림확인</a>에서 확인할 수 있습니다.
    </p>
    <div style="display: flex; gap: 8px; flex-wrap: wrap">
      <a href="{% url 'fall_record_add' %}" class="btn btn-primary">직접 기록 추가하기</a>
      {% url 'fall_record_export' as export_base %}
      {% if export_query %}
        {% with export_base|add:'?'|add:export_query as export_url %}
        <a href="{{ export_url }}" class="btn btn-outline">CSV 내보내기</a>
        {% endwith %}
      {% else %}
        <a href="{{ export_base }}" class="btn btn-outline">CSV 내보내기</a>
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}
