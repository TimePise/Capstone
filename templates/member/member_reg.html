{% extends "member/base.html" %}
{% load static %}
{% block title %}회원가입{% endblock %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="auth-wrapper">
  <div class="auth-card auth-card--wide">
    <div>
      <p class="auth-card__subtitle">안전한 병동 케어 파트너</p>
      <h1 class="auth-card__title">회원가입</h1>
    </div>
    <p class="text-muted">낙상감지시스템 사용을 위한 병동 계정을 생성합니다.</p>

    {% if message %}
    <div class="alert alert-error">{{ message }}</div>
    {% endif %}

    <form method="POST" class="auth-form" id="signup-form">
      {% csrf_token %}
      <div class="input-field">
        <label for="member_id">아이디</label>
        <input
          type="text"
          id="member_id"
          name="member_id"
          class="input-control"
          placeholder="아이디"
          value="{{ member_id|default_if_none:'' }}"
          required
        />
      </div>
      <div class="input-field">
        <label for="password">비밀번호</label>
        <div class="input-password">
          <input
            type="password"
            id="password"
            name="passwd"
            class="input-control"
            placeholder="비밀번호"
            required
          />
          <button type="button" id="toggleSignupPassword">보기</button>
        </div>
      </div>
      <div class="input-field">
        <label for="name">이름</label>
        <input
          type="text"
          id="name"
          name="name"
          class="input-control"
          placeholder="이름"
          value="{{ name|default_if_none:'' }}"
          required
        />
      </div>
      <div class="input-field">
        <label for="ward_name">병동명</label>
        <input
          type="text"
          id="ward_name"
          name="ward_name"
          class="input-control"
          placeholder="병동명"
          value="{{ ward_name|default_if_none:'' }}"
          required
        />
      </div>
      <div class="input-field">
        <label for="phone">전화번호</label>
        <input
          type="tel"
          id="phone"
          name="phone"
          class="input-control"
          placeholder="휴대전화 번호 (- 없이 입력)"
          value="{{ phone|default_if_none:'' }}"
          required
        />
      </div>
      <div class="input-field">
        <label for="code">인증번호</label>
        <div class="input-inline">
          <input
            type="text"
            id="code"
            name="code"
            class="input-control"
            placeholder="인증번호 입력"
            required
          />
          <button type="button" class="btn btn-outline" id="signup-send-code">인증번호 받기</button>
        </div>
      </div>
      <button type="submit" class="btn btn-primary btn-block">가입하기</button>
    </form>

    <div class="auth-links">
      <a href="{% url 'member_login' %}">로그인</a>
      <a href="{% url 'find_id' %}">아이디 찾기</a>
      <a href="{% url 'find_password' %}">비밀번호 찾기</a>
    </div>
  </div>
</div>

<script>
  const signupForm = document.getElementById("signup-form");
  const signupPwInput = document.getElementById("password");
  const signupToggleBtn = document.getElementById("toggleSignupPassword");
  const signupSendBtn = document.getElementById("signup-send-code");

  const getSignupToken = () => signupForm.querySelector('input[name="csrfmiddlewaretoken"]').value;

  signupToggleBtn.addEventListener("click", () => {
    const isPassword = signupPwInput.type === "password";
    signupPwInput.type = isPassword ? "text" : "password";
    signupToggleBtn.textContent = isPassword ? "숨기기" : "보기";
  });

  signupSendBtn.addEventListener("click", () => {
    const phone = document.getElementById("phone").value.trim();
    if (!phone) {
      Swal.fire({
        icon: "warning",
        title: "전화번호 없음",
        text: "전화번호를 입력하세요.",
      });
      return;
    }

    fetch("{% url 'send_verification_code' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": getSignupToken(),
      },
      body: new URLSearchParams({ phone }).toString(),
    })
      .then((response) => response.json())
      .then(() => {
        Swal.fire({
          icon: "success",
          title: "인증번호 전송 완료",
          text: "📩 인증번호가 전송되었습니다!",
          confirmButtonText: "확인",
        });
      })
      .catch(() => {
        Swal.fire({
          icon: "error",
          title: "전송 실패",
          text: "🚫 인증번호 전송에 실패했습니다.",
        });
      });
  });
</script>

{% endblock %}
