{% extends "member/base.html" %}
{% block title %}ì•„ì´ë”” ì°¾ê¸°{% endblock %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="auth-wrapper">
  <div class="auth-card auth-card--wide">
    <div>
      <p class="auth-card__subtitle">ì•ˆì „í•œ ë³‘ë™ ì¼€ì–´ íŒŒíŠ¸ë„ˆ</p>
      <h1 class="auth-card__title">ì•„ì´ë”” ì°¾ê¸°</h1>
    </div>
    <p class="text-muted">ê°€ì… ì‹œ ì‚¬ìš©í•œ ì •ë³´ë¡œ ë³¸ì¸ ì¸ì¦ í›„ ì•„ì´ë””ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>

    <div id="error" class="alert alert-error" style="display: none"></div>
    <div id="result" class="alert alert-success" style="display: none"></div>

    <form id="find-id-form" method="POST" action="{% url 'verify_id' %}" class="auth-form">
      {% csrf_token %}
      <div class="input-field">
        <label for="name">ì´ë¦„</label>
        <input type="text" id="name" name="name" class="input-control" placeholder="ì´ë¦„" required />
      </div>
      <div class="input-field">
        <label for="phone">ì „í™”ë²ˆí˜¸</label>
        <input
          type="text"
          id="phone"
          name="phone"
          class="input-control"
          placeholder="íœ´ëŒ€ì „í™” ë²ˆí˜¸ (- ì—†ì´ ì…ë ¥)"
          required
        />
      </div>
      <div class="input-field">
        <label for="code">ì¸ì¦ë²ˆí˜¸</label>
        <div style="display: flex; gap: 10px">
          <input
            type="text"
            id="code"
            name="code"
            class="input-control"
            placeholder="ì¸ì¦ë²ˆí˜¸ ì…ë ¥"
            required
            style="flex: 1"
          />
          <button type="button" id="send-code-btn" class="btn btn-outline" style="min-width: 150px">
            ì¸ì¦ë²ˆí˜¸ ë°›ê¸°
          </button>
        </div>
      </div>
      <button type="submit" class="btn btn-primary btn-block">ì•„ì´ë”” ì°¾ê¸°</button>
    </form>

    <div class="auth-links">
      <a href="{% url 'member_login' %}">ë¡œê·¸ì¸</a>
      <a href="{% url 'find_password' %}">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a>
      <a href="{% url 'member_reg' %}">íšŒì›ê°€ì…</a>
    </div>
  </div>
</div>

<script>
  const form = document.getElementById("find-id-form");
  const sendBtn = document.getElementById("send-code-btn");
  const errorBox = document.getElementById("error");
  const resultBox = document.getElementById("result");

  const showMessage = (el, text) => {
    if (!text) {
      el.style.display = "none";
      el.textContent = "";
      return;
    }
    el.textContent = text;
    el.style.display = "block";
  };

  const getCsrfToken = () => form.querySelector('input[name="csrfmiddlewaretoken"]').value;

  sendBtn.addEventListener("click", function () {
    const phone = document.getElementById("phone").value.trim();
    if (!phone) {
      Swal.fire({ icon: "warning", text: "ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." });
      return;
    }

    fetch("{% url 'send_verification_code' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": getCsrfToken(),
      },
      body: "phone=" + encodeURIComponent(phone),
    })
      .then((res) => res.json())
      .then(() => {
        Swal.fire({
          icon: "success",
          title: "ì¸ì¦ë²ˆí˜¸ ì „ì†¡ ì™„ë£Œ",
          text: "ğŸ“© ì¸ì¦ë²ˆí˜¸ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!",
          confirmButtonText: "í™•ì¸",
        });
      })
      .catch(() => {
        Swal.fire({
          icon: "error",
          title: "ì „ì†¡ ì‹¤íŒ¨",
          text: "ğŸš« ì¸ì¦ë²ˆí˜¸ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
        });
      });
  });

  form.addEventListener("submit", function (e) {
    e.preventDefault();

    const name = form.name.value.trim();
    const phone = form.phone.value.trim();
    const code = form.code.value.trim();

    const params = new URLSearchParams({ name, phone, code });

    fetch("{% url 'verify_id' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": getCsrfToken(),
      },
      body: params.toString(),
    })
      .then((res) => {
        if (!res.ok) throw res;
        return res.json();
      })
      .then((data) => {
        showMessage(errorBox, "");
        showMessage(resultBox, `ê³ ê°ë‹˜ì˜ ì•„ì´ë””ëŠ” ${data.member_id} ì…ë‹ˆë‹¤.`);
      })
      .catch(async (err) => {
        const errData = await err.json();
        showMessage(errorBox, "âŒ " + (errData.status || "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."));
        showMessage(resultBox, "");
      });
  });
</script>
{% endblock %}
