{% extends "member/base.html" %}
<!-- prettier-ignore-start -->
{% block title %}ì•„ì´ë”” ì°¾ê¸°{% endblock %} {% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<h2 style="text-align: center; font-size: 36px; font-weight: bold">
  ì•„ì´ë”” ì°¾ê¸°
</h2>
<br />

<div style="max-width: 400px; margin: 0 auto">
  <form id="find-id-form" method="POST" action="{% url 'verify_id' %}">
    {% csrf_token %}
    <input
      type="text"
      name="name"
      placeholder="ì´ë¦„"
      required
      style="
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        background: #f1f3f2;
      "
    />
    <input
      type="text"
      name="phone"
      placeholder="ì „í™”ë²ˆí˜¸"
      required
      style="
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        background: #f1f3f2;
      "
    />

    <!-- ì¸ì¦ë²ˆí˜¸ ì…ë ¥ & ë²„íŠ¼ -->
    <div style="display: flex; gap: 10px; margin-bottom: 10px">
      <input
        type="text"
        id="code"
        name="code"
        placeholder="ì¸ì¦ë²ˆí˜¸ ì…ë ¥"
        style="flex: 2; padding: 12px; background: #f1f3f2"
      />
      <button type="button" id="send-code-btn" style="flex: 1; padding: 12px">
        ì¸ì¦ë²ˆí˜¸ ë°›ê¸°
      </button>
    </div>

    <div id="error" style="color: red; font-size: 14px"></div>
    <div
      id="result"
      style="margin-top: 20px; font-weight: bold; text-align: center"
    ></div>

    <button
      type="submit"
      style="
        width: 100%;
        padding: 14px;
        background: black;
        color: white;
        font-size: 16px;
        border: none;
        margin-top: 15px;
      "
    >
      ì•„ì´ë”” ì°¾ê¸°
    </button>
  </form>
</div>

<script>
  document
    .getElementById("send-code-btn")
    .addEventListener("click", function () {
      const phone = document.querySelector('input[name="phone"]').value;
      if (!phone) {
        Swal.fire({ icon: "warning", text: "ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”." });
        return;
      }

      fetch("{% url 'send_verification_code' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: "phone=" + encodeURIComponent(phone),
      })
        .then((res) => res.json())
        .then((data) => {
          Swal.fire({
            icon: "success",
            title: "ì¸ì¦ë²ˆí˜¸ ì „ì†¡ ì™„ë£Œ",
            text: "ğŸ“© ì¸ì¦ë²ˆí˜¸ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!",
            confirmButtonText: "í™•ì¸",
          });
        })
        .catch((err) => {
          Swal.fire({
            icon: "error",
            title: "ì „ì†¡ ì‹¤íŒ¨",
            text: "ğŸš« ì¸ì¦ë²ˆí˜¸ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
          });
        });
    });

  document
    .getElementById("find-id-form")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const form = e.target;
      const name = form.name.value;
      const phone = form.phone.value;
      const code = form.code.value;

      fetch("{% url 'verify_id' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body:
          "name=" +
          encodeURIComponent(name) +
          "&phone=" +
          encodeURIComponent(phone) +
          "&code=" +
          encodeURIComponent(code),
      })
        .then((res) => {
          if (!res.ok) throw res;
          return res.json();
        })
        .then((data) => {
          document.getElementById("error").textContent = "";
          document.getElementById(
            "result"
          ).textContent = `ê³ ê°ë‹˜ì˜ ì•„ì´ë””ëŠ” ${data.member_id} ì…ë‹ˆë‹¤.`;
        })
        .catch(async (err) => {
          const errData = await err.json();
          document.getElementById("error").textContent =
            "âŒ " + (errData.status || "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          document.getElementById("result").textContent = "";
        });
    });
</script>
{% endblock %}
