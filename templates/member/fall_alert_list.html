{% extends "member/base.html" %} {% block title %}ë‚™ìƒ ì•Œë¦¼ ëª©ë¡{% endblock %}
{% block content %}
<div style="max-width: 800px; margin: 60px auto; padding: 0 20px">
  <h2
    style="
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 40px;
    "
  >
    ë‚™ìƒ ì•Œë¦¼ ëª©ë¡
  </h2>

  <div id="alert-container">
    {% for alert in alerts %}
    <div
      style="
        background-color: {% if alert.fall_level == 'ê³ ìœ„í—˜' %}#e74c3c
                          {% elif alert.fall_level == 'ì¤‘ìœ„í—˜' %}#3498db
                          {% else %}#f1c40f{% endif %};
        color: {% if alert.fall_level == 'ì €ìœ„í—˜' %}#333{% else %}white{% endif %};
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      "
    >
      <p><strong>í™˜ìëª…:</strong> {{ alert.name }}</p>
      <p><strong>ë³‘ë™/í˜¸ì‹¤:</strong> {{ alert.room_number }}</p>
      <p><strong>ë‚™ìƒ ë‹¨ê³„:</strong> {{ alert.fall_level }}</p>
      <p><strong>ë‚™ìƒ ë¶€ìœ„:</strong> {{ alert.part }}</p>
      <p><strong>ì‹œê°„:</strong> {{ alert.timestamp|date:"Y-m-d H:i:s" }}</p>
    </div>
    {% empty %}
    <p style="text-align: center; color: #666">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endfor %}
  </div>
</div>

<script>
  const alertContainer = document.getElementById("alert-container");

  // âœ… SSE ì—°ê²°
  const sse = new EventSource("{% url 'fall_alert_stream' %}");

  sse.onmessage = function (event) {
    const data = JSON.parse(event.data);

    // âœ… ë‚ ì§œ í¬ë§· ë³€í™˜
    const timeText = new Date(data.timestamp).toLocaleString("ko-KR", {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });

    // âœ… ìƒ‰ìƒ ì„¤ì •
    let bgColor = "#bdc3c7";
    let textColor = "white";
    if (data.fall_level === "ê³ ìœ„í—˜") bgColor = "#e74c3c";
    else if (data.fall_level === "ì¤‘ìœ„í—˜") bgColor = "#3498db";
    else {
      bgColor = "#f1c40f";
      textColor = "#333";
    }

    // âœ… ì¹´ë“œ ìƒì„±
    const newAlert = document.createElement("div");
    newAlert.style = `
      background-color: ${bgColor};
      color: ${textColor};
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    `;

    newAlert.innerHTML = `
      <p style="margin-bottom: 10px;"><strong style="color: #00bfff;">ğŸ†• ì‹¤ì‹œê°„ ì•Œë¦¼</strong></p>
      <p><strong>í™˜ìëª…:</strong> ${data.name}</p>
      <p><strong>ë³‘ë™/í˜¸ì‹¤:</strong> ${data.room_number}</p>
      <p><strong>ë‚™ìƒ ë‹¨ê³„:</strong> ${data.fall_level}</p>
      <p><strong>ë‚™ìƒ ë¶€ìœ„:</strong> ${data.part}</p>
      <p><strong>ì‹œê°„:</strong> ${timeText}</p>
    `;

    alertContainer.prepend(newAlert);
  };

  sse.onerror = function (err) {
    console.error("SSE ì—°ê²° ì‹¤íŒ¨:", err);
    sse.close();
  };
</script>
{% endblock %}
