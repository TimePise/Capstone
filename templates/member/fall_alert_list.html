{% extends "member/base.html" %}
{% block title %}낙상 알림 목록{% endblock %}
{% block content %}
<style>
  .alert-dashboard {
    display: flex;
    flex-direction: column;
    gap: 28px;
  }

  .alert-headline h2 {
    margin: 0;
    font-size: 1.8rem;
    letter-spacing: -0.02em;
  }

  .stat-chips {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 14px;
  }

  .chip-card {
    border-radius: 20px;
    border: 1px solid var(--border-light);
    background: #f7f9ff;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .chip-card span {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .chip-card strong {
    font-size: 1.6rem;
    font-weight: 700;
  }

  .filter-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    border-radius: 24px;
    background: var(--card-bg);
    border: 1px solid var(--border-light);
    padding: 16px 20px;
    align-items: center;
  }

  .btn {
    border: none;
    border-radius: 999px;
    padding: 10px 18px;
    font-size: 0.95rem;
    cursor: pointer;
    transition: transform 0.1s ease, box-shadow 0.2s ease;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
    box-shadow: 0 12px 24px rgba(90, 110, 220, 0.3);
  }

  .btn-outline {
    background: transparent;
    color: var(--text-muted);
    border: 1px solid var(--border-light);
  }

  .btn:hover {
    transform: translateY(-1px);
  }

  .filter-toolbar label {
    font-size: 0.9rem;
    color: var(--text-muted);
  }

  .filter-toolbar select {
    border: 1px solid var(--border-light);
    border-radius: 14px;
    padding: 10px 12px;
    background: #f7f8fc;
    font-family: inherit;
    font-size: 0.95rem;
  }

  .alert-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .alert-card {
    border-radius: 24px;
    padding: 20px 24px;
    color: #fff;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    position: relative;
    overflow: hidden;
  }

  .alert-card::after {
    content: "";
    position: absolute;
    right: -60px;
    top: -60px;
    width: 140px;
    height: 140px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.15);
  }

  .alert-card__label {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.9;
  }

  .alert-card__value {
    font-size: 1.2rem;
    font-weight: 600;
  }

  .alert-card.safe {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    color: #654321;
  }

  .alert-card.warning {
    background: linear-gradient(135deg, #91c9ff, #5ba4f7);
  }

  .alert-card.critical {
    background: linear-gradient(135deg, #ff6b6b, #c81d77);
  }

.alert-card__actions {
  display: flex;
  align-items: center;
  gap: 12px;
  justify-content: flex-end;
}

.alert-badge {
  display: inline-flex;
  align-items: center;
  padding: 8px 16px;
  border-radius: 999px;
  font-size: 0.85rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

.badge-unread {
  background: rgba(255, 255, 255, 0.35);
  color: #fff;
  box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4);
}

.badge-read {
  background: rgba(255, 255, 255, 0.9);
  color: #374151;
}

.btn-small {
  padding: 10px 18px;
  font-size: 0.85rem;
  border-radius: 999px;
  font-weight: 600;
  text-transform: uppercase;
}

.mark-read-btn {
  border: none;
  background: rgba(255, 255, 255, 0.92);
  color: #c81d77;
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.12);
}

.mark-read-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 12px 22px rgba(0, 0, 0, 0.18);
}

.mark-read-btn:disabled {
  background: rgba(255, 255, 255, 0.45);
  color: rgba(55, 65, 81, 0.6);
  box-shadow: none;
  cursor: not-allowed;
}

  .empty-alert {
    text-align: center;
    color: var(--text-muted);
    padding: 60px 0;
  }
</style>

<section class="page-card alert-dashboard">
  <div class="alert-headline">
    <h2>실시간 낙상 알림</h2>
    <p style="color: var(--text-muted); margin: 6px 0 0">
      최근 50건의 알림을 보여주며, 실시간 스트림으로 새 알림이 자동 추가됩니다.
    </p>
  </div>

  <div class="stat-chips">
    <div class="chip-card">
      <span>전체 알림</span>
      <strong>{{ summary.total }}</strong>
      <small style="color: var(--text-muted)">누적 발생</small>
    </div>
    <div class="chip-card">
      <span>읽지 않은 알림</span>
      <strong>{{ summary.unread }}</strong>
      <small style="color: var(--text-muted)">확인 필요</small>
    </div>
    <div class="chip-card">
      <span>고위험</span>
      <strong>{{ summary.levels.고위험|default:0 }}</strong>
      <small style="color: #b91c1c">즉시 대응</small>
    </div>
    <div class="chip-card">
      <span>최근 발생</span>
      <strong>
        {% if summary.latest %}
          {{ summary.latest.timestamp|date:"m.d H:i" }}
        {% else %}
          -
        {% endif %}
      </strong>
      <small style="color: var(--text-muted)">마지막 알림 시각</small>
    </div>
  </div>

  <form method="GET" class="filter-toolbar">
    <div style="display: flex; flex-direction: column; gap: 4px">
      <label for="level">위험 단계</label>
      <select name="level" id="level">
        <option value="">전체</option>
        <option value="고위험" {% if filters.level == "고위험" %}selected{% endif %}>고위험</option>
        <option value="중위험" {% if filters.level == "중위험" %}selected{% endif %}>중위험</option>
        <option value="저위험" {% if filters.level == "저위험" %}selected{% endif %}>저위험</option>
      </select>
    </div>
    <div style="display: flex; flex-direction: column; gap: 4px">
      <label for="status">확인 여부</label>
      <select name="status" id="status">
        <option value="">전체</option>
        <option value="unread" {% if filters.status == "unread" %}selected{% endif %}>미확인</option>
        <option value="read" {% if filters.status == "read" %}selected{% endif %}>확인완료</option>
      </select>
    </div>
    <div style="margin-left: auto; display: flex; gap: 10px">
      <button type="submit" class="btn btn-primary">필터 적용</button>
      <a href="{% url 'fall_alert_list' %}" class="btn btn-outline">초기화</a>
    </div>
  </form>

  <div class="alert-list" id="alert-container">
    {% for alert in alerts %}
    <article
      class="alert-card {% if alert.fall_level == '고위험' %}critical{% elif alert.fall_level == '중위험' %}warning{% else %}safe{% endif %}"
    >
      <div>
        <p class="alert-card__label">환자명</p>
        <p class="alert-card__value">{{ alert.name }}</p>
      </div>
      <div>
        <p class="alert-card__label">병동/호실</p>
        <p class="alert-card__value">{{ alert.room_number }}</p>
      </div>
      <div>
        <p class="alert-card__label">위험 단계</p>
        <p class="alert-card__value">{{ alert.fall_level }}</p>
      </div>
      <div>
        <p class="alert-card__label">낙상 부위</p>
        <p class="alert-card__value">{{ alert.part }}</p>
      </div>
      <div>
        <p class="alert-card__label">시간</p>
        <p class="alert-card__value">{{ alert.timestamp|date:"Y-m-d H:i:s" }}</p>
      </div>
      <div class="alert-card__actions">
        <span class="alert-badge {% if alert.is_read %}badge-read{% else %}badge-unread{% endif %}">
          {% if alert.is_read %}확인완료{% else %}미확인{% endif %}
        </span>
        <button
          class="btn btn-outline btn-small mark-read-btn"
          data-alert-id="{{ alert.id }}"
          {% if alert.is_read %}disabled{% endif %}
        >
          확인완료
        </button>
      </div>
    </article>
    {% empty %}
    <p class="empty-alert">조건에 맞는 알림이 없습니다.</p>
    {% endfor %}
  </div>
</section>

<form id="csrf-form" style="display: none">{% csrf_token %}</form>

<script>
  const alertContainer = document.getElementById("alert-container");
  const csrfTokenInput = document.querySelector("#csrf-form input[name='csrfmiddlewaretoken']");
  const csrfToken = csrfTokenInput ? csrfTokenInput.value : "";
  const markUrlTemplate = "{% url 'fall_alert_mark' 0 %}";

  const buildMarkUrl = (id) => markUrlTemplate.replace(/0\/$/, id + "/");

  function attachMarkHandler(button) {
    if (!button) return;
    button.addEventListener("click", () => {
      if (button.disabled) return;
      const alertId = button.dataset.alertId;
      fetch(buildMarkUrl(alertId), {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
        },
      })
        .then((res) => {
          if (!res.ok) throw new Error("failed");
          return res.json();
        })
        .then(() => {
          button.disabled = true;
          const card = button.closest(".alert-card");
          const badge = card.querySelector(".alert-badge");
          if (badge) {
            badge.textContent = "확인완료";
            badge.classList.remove("badge-unread");
            badge.classList.add("badge-read");
          }
        })
        .catch((err) => {
          console.error("알림 확인 실패", err);
        });
    });
  }

  document.querySelectorAll(".mark-read-btn").forEach(attachMarkHandler);

  const sse = new EventSource("{% url 'fall_alert_stream' %}");

  sse.onmessage = function (event) {
    const data = JSON.parse(event.data);
    const card = document.createElement("article");
    const levelClass =
      data.fall_level === "고위험"
        ? "critical"
        : data.fall_level === "중위험"
        ? "warning"
        : "safe";

    const timeText = new Date(data.timestamp).toLocaleString("ko-KR", {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });

    card.className = `alert-card ${levelClass}`;
    card.innerHTML = `
      <div>
        <p class="alert-card__label">환자명</p>
        <p class="alert-card__value">${data.name}</p>
      </div>
      <div>
        <p class="alert-card__label">병동/호실</p>
        <p class="alert-card__value">${data.room_number}</p>
      </div>
      <div>
        <p class="alert-card__label">위험 단계</p>
        <p class="alert-card__value">${data.fall_level}</p>
      </div>
      <div>
        <p class="alert-card__label">낙상 부위</p>
        <p class="alert-card__value">${data.part}</p>
      </div>
      <div>
        <p class="alert-card__label">시간</p>
        <p class="alert-card__value">${timeText}</p>
      </div>
      <div class="alert-card__actions">
        <span class="alert-badge badge-unread">미확인</span>
        <button class="btn btn-outline btn-small mark-read-btn" data-alert-id="${data.id}">
          확인완료
        </button>
      </div>
    `;

    alertContainer.prepend(card);
    attachMarkHandler(card.querySelector(".mark-read-btn"));
  };

  sse.onerror = function (err) {
    console.error("SSE 연결 실패:", err);
    sse.close();
  };
</script>
{% endblock %}
