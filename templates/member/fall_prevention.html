{% extends "member/base.html" %} {% block title %}낙상감지시스템{% endblock %}
{% block content %}
<style>
  .container {
    padding: 40px;
    max-width: 1200px;
    margin: 0 auto;
  }

  .title {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 30px;
  }

  .camera-box {
    position: relative;
    background-color: black;
    width: 100%;
    aspect-ratio: 4 / 3;
    border-radius: 8px;
    overflow: hidden;
  }

  .camera-box img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background-color: black;
    border-radius: 8px;
  }

  .privacy-overlay {
    position: absolute;
    top: 16px;
    right: 16px;
    background-color: rgba(0, 0, 0, 0.75);
    color: #fff;
    padding: 8px 16px;
    border-radius: 999px;
    font-size: 0.9rem;
    z-index: 10;
    display: none;
    pointer-events: none;
  }

  .button-wrapper {
    margin-top: 20px;
    display: flex;
    justify-content: flex-start;
    align-items: center;
  }

  .protect-button {
    background-color: #5a6edc;
    color: white;
    padding: 10px 20px;
    font-size: 0.95rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }

  #status-text {
    font-size: 1rem;
    font-weight: bold;
    margin-top: 10px;
    color: green;
  }
</style>

<div class="container">
  <div class="title">낙상감지시스템</div>

  <!-- ✅ 카메라 스트리밍 -->
  <div class="camera-box" id="camera-box">
    <img
      id="camera-stream"
      src="{% url 'pose_estimation_feed' %}"
      alt="카메라 스트리밍"
    />
    <div class="privacy-overlay" id="privacy-overlay"></div>
  </div>

  <!-- ✅ 버튼 -->
  <div class="button-wrapper">
    <button id="privacy-btn" class="protect-button" onclick="togglePrivacy()">
      보호모드 켜기
    </button>
  </div>
  <p id="status-text">상태 확인 중...</p>
</div>

<script>
  const overlay = document.getElementById("privacy-overlay");
  const btn = document.getElementById("privacy-btn");
  let isPrivacyMode = {{ privacy_mode|yesno:"true,false" }};

  function applyPrivacyUI(state) {
    overlay.style.display = state ? "block" : "none";
    if (state) {
      btn.style.backgroundColor = "#e74c3c";
      btn.textContent = "보호모드 끄기";
    } else {
      btn.style.backgroundColor = "#5a6edc";
      btn.textContent = "보호모드 켜기";
    }
  }

  applyPrivacyUI(isPrivacyMode);

  function togglePrivacy() {
    const optimisticState = !isPrivacyMode;
    applyPrivacyUI(optimisticState);
    fetch("{% url 'toggle_privacy_mode' %}")
      .then((res) => res.json())
      .then((data) => {
        isPrivacyMode = data.privacy_mode;
        applyPrivacyUI(isPrivacyMode);
      })
      .catch((err) => {
        console.error("보호모드 전환 실패", err);
        applyPrivacyUI(isPrivacyMode);
      });
  }

  function pollFallStatus() {
    fetch("{% url 'fall_status' %}")
      .then((res) => res.json())
      .then((data) => {
        const status = document.getElementById("status-text");
        status.textContent = data.label;
        status.style.color = data.fall ? "red" : "green";
      })
      .catch((err) => console.error("상태 요청 실패:", err));
  }

  setInterval(pollFallStatus, 1000);

  const sse = new EventSource("{% url 'fall_alert_stream' %}");

  sse.onmessage = function (event) {
    const data = JSON.parse(event.data);
    console.log("새 알림:", data.message, data.fall_level);
  };

  sse.onerror = function (err) {
    console.error("SSE 연결 실패:", err);
    sse.close();
  };
</script>
{% endblock %}
