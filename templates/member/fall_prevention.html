{% extends "member/base.html" %} {% block title %}ë‚™ìƒê°ì§€ì‹œìŠ¤í…œ{% endblock %}
{% block content %}
<style>
  :root {
    color-scheme: light;
  }

  .monitor-container {
    padding: 36px 32px 60px;
    max-width: 1280px;
    margin: 0 auto;
  }

  .monitor-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 28px;
  }

  .monitor-layout {
    display: flex;
    gap: 28px;
    flex-wrap: wrap;
  }

  .monitor-left {
    flex: 1 1 620px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .monitor-right {
    flex: 1 1 320px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .camera-wrapper {
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    background: #040406;
    min-height: 340px;
    box-shadow: 0 18px 45px rgba(18, 28, 75, 0.3);
  }

  .camera-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  .status-pill {
    position: absolute;
    left: 20px;
    top: 20px;
    padding: 8px 16px;
    border-radius: 999px;
    font-weight: 600;
    font-size: 0.95rem;
    color: #0b1b0f;
    background: rgba(168, 247, 191, 0.85);
    display: flex;
    align-items: center;
    gap: 6px;
    backdrop-filter: blur(4px);
  }

  .status-pill.danger {
    background: rgba(255, 99, 132, 0.9);
    color: #fff;
  }

  .privacy-badge {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 0.85rem;
    padding: 8px 14px;
    border-radius: 999px;
    background: rgba(21, 24, 38, 0.9);
    color: #cdd7ff;
    display: flex;
    align-items: center;
    gap: 6px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .privacy-badge.active {
    opacity: 1;
  }

  .monitor-card {
    background: #fff;
    border-radius: 16px;
    padding: 20px 22px;
    box-shadow: 0 12px 35px rgba(21, 31, 77, 0.1);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
  }

  .card-header h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 700;
  }

  .card-header span {
    font-size: 0.85rem;
    color: #7e819a;
  }

  .trend-chart {
    display: flex;
    gap: 10px;
  }

  .trend-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }

  .trend-bar {
    width: 100%;
    height: 70px;
    border-radius: 10px;
    background: linear-gradient(135deg, #76e0a6, #90f0d0);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: #0d2416;
  }

  .trend-bar.danger {
    background: linear-gradient(135deg, #f87171, #f43f5e);
    color: #fff;
  }

  .trend-time {
    font-size: 0.8rem;
    color: #8f91a3;
  }

  .control-card {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }

  .toggle-label {
    display: flex;
    flex-direction: column;
    font-weight: 600;
  }

  .toggle-desc {
    font-size: 0.85rem;
    color: #84879b;
    margin-top: 2px;
  }

  .switch {
    position: relative;
    display: inline-flex;
    width: 62px;
    height: 32px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .switch-track {
    position: absolute;
    inset: 0;
    background: #ced3f0;
    border-radius: 999px;
    transition: background 0.2s ease;
  }

  .switch-thumb {
    position: absolute;
    height: 26px;
    width: 26px;
    left: 4px;
    top: 3px;
    border-radius: 50%;
    background: #fff;
    box-shadow: 0 6px 12px rgba(19, 27, 70, 0.25);
    transition: transform 0.2s ease;
  }

  .switch input:checked + .switch-track {
    background: #5563ff;
  }

  .switch input:checked + .switch-track + .switch-thumb {
    transform: translateX(30px);
  }

  .alert-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 360px;
    overflow-y: auto;
    padding-right: 6px;
  }

  .alert-card {
    border-radius: 12px;
    padding: 14px 16px;
    border: 1px solid #eef0fb;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .alert-card.level-critical {
    border-color: #fda4af;
    background: linear-gradient(135deg, #ff6b6b, #c81d77);
    color: #fff;
  }

  .alert-card.level-warning {
    border-color: #bfdbfe;
    background: linear-gradient(135deg, #91c9ff, #5ba4f7);
    color: #0f172a;
  }

  .alert-card.level-safe {
    border-color: #feeaa4;
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    color: #7a4b00;
  }

  .alert-meta {
    font-size: 0.85rem;
    color: #7c7f95;
  }

  .alert-title {
    font-weight: 700;
    font-size: 1rem;
  }

  .empty-state {
    text-align: center;
    color: #9da0b8;
    padding: 20px 0;
    font-size: 0.95rem;
  }

  @media (max-width: 960px) {
    .monitor-layout {
      flex-direction: column;
    }
    .monitor-right {
      width: 100%;
    }
  }
</style>

<div class="monitor-container">
  <div class="monitor-title">ë‚™ìƒê°ì§€ì‹œìŠ¤í…œ</div>
  <div class="monitor-layout">
    <section class="monitor-left">
      <div class="camera-wrapper">
        <div class="status-pill" id="live-status">ìƒíƒœ í™•ì¸ ì¤‘...</div>
        <div class="privacy-badge" id="privacy-overlay">
          <span>ğŸ”’ ë³´í˜¸ëª¨ë“œ</span>
        </div>
        <img
          id="camera-stream"
          src="{% url 'pose_estimation_feed' %}"
          alt="ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¬ë°"
        />
      </div>

      <div class="monitor-card">
        <div class="card-header">
          <h3>ì‹¤ì‹œê°„ ìƒíƒœ ì¶”ì„¸</h3>
          <span id="last-updated">ìµœê·¼ ì—…ë°ì´íŠ¸ : -</span>
        </div>
        <div class="trend-chart" id="trend-chart">
          <div class="empty-state">ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</div>
        </div>
      </div>
    </section>

    <section class="monitor-right">
      <div class="monitor-card control-card">
        <div class="toggle-row">
          <div class="toggle-label">
            ë³´í˜¸ëª¨ë“œ
            <span class="toggle-desc">ì˜ìƒ ê°€ë¦¼ ìƒíƒœë¥¼ ì›í„°ì¹˜ë¡œ ì „í™˜í•©ë‹ˆë‹¤.</span>
          </div>
          <label class="switch">
            <input
              type="checkbox"
              id="privacy-switch"
              onchange="togglePrivacy()"
            />
            <span class="switch-track"></span>
            <span class="switch-thumb"></span>
          </label>
        </div>
        <div class="toggle-desc" id="privacy-detail">
          í˜„ì¬ ìƒíƒœ í™•ì¸ ì¤‘...
        </div>
      </div>

      <div class="monitor-card">
        <div class="card-header">
          <h3>ì‹¤ì‹œê°„ ë‚™ìƒ ì•Œë¦¼</h3>
          <span>ìµœê·¼ 4ê±´</span>
        </div>
        <div class="alert-list" id="alert-feed">
          <div class="empty-state">ì•„ì§ ë„ì°©í•œ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
  const overlay = document.getElementById("privacy-overlay");
  const liveStatus = document.getElementById("live-status");
  const privacySwitch = document.getElementById("privacy-switch");
  const privacyDetail = document.getElementById("privacy-detail");
  const trendChart = document.getElementById("trend-chart");
  const lastUpdated = document.getElementById("last-updated");
  const alertFeed = document.getElementById("alert-feed");

  let isPrivacyMode = {{ privacy_mode|yesno:"true,false" }};
  let statusHistory = [];
  const alerts = [];

  function applyPrivacyUI(state) {
    overlay.classList.toggle("active", state);
    privacySwitch.checked = state;
    privacyDetail.textContent = state
      ? "ì¹´ë©”ë¼ ì˜ìƒì´ ë³´í˜¸ëª¨ë“œë¡œ ê°€ë ¤ì§„ ìƒíƒœì…ë‹ˆë‹¤."
      : "ì˜ìƒì´ ê³µê°œë˜ì–´ ìˆìœ¼ë©° ìì„¸í•œ ê°ì§€ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.";
  }

  applyPrivacyUI(isPrivacyMode);

  function togglePrivacy() {
    const optimisticState = !isPrivacyMode;
    applyPrivacyUI(optimisticState);
    fetch("{% url 'toggle_privacy_mode' %}")
      .then((res) => res.json())
      .then((data) => {
        isPrivacyMode = data.privacy_mode;
        applyPrivacyUI(isPrivacyMode);
      })
      .catch((err) => {
        console.error("ë³´í˜¸ëª¨ë“œ ì „í™˜ ì‹¤íŒ¨", err);
        applyPrivacyUI(isPrivacyMode);
      });
  }

  function renderTrend() {
    if (!statusHistory.length) {
      trendChart.innerHTML =
        '<div class="empty-state">ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</div>';
      return;
    }
    trendChart.innerHTML = statusHistory
      .map(
        (entry) => `
        <div class="trend-item">
          <div class="trend-bar ${entry.fall ? "danger" : ""}">
            ${entry.fall ? "ë‚™ìƒ" : "ì •ìƒ"}
          </div>
          <span class="trend-time">${entry.time}</span>
        </div>
      `
      )
      .join("");
  }

  function updateStatusView(data) {
    liveStatus.textContent = data.label;
    liveStatus.classList.toggle("danger", data.fall);
    const now = new Date();
    const timeLabel = now.toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit",
    });
    lastUpdated.textContent = `ìµœê·¼ ì—…ë°ì´íŠ¸ : ${timeLabel}`;
    statusHistory = [
      ...statusHistory.slice(-5),
      { fall: data.fall, time: timeLabel },
    ];
    renderTrend();
  }

  function pollFallStatus() {
    fetch("{% url 'fall_status' %}")
      .then((res) => res.json())
      .then(updateStatusView)
      .catch((err) => console.error("ìƒíƒœ ìš”ì²­ ì‹¤íŒ¨:", err));
  }

  pollFallStatus();
  setInterval(pollFallStatus, 1500);

  function renderAlerts() {
    if (!alerts.length) {
      alertFeed.innerHTML =
        '<div class="empty-state">ì•„ì§ ë„ì°©í•œ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    alertFeed.innerHTML = alerts
      .map(
        (alert) => {
          const levelClass =
            alert.fall_level === "ê³ ìœ„í—˜"
              ? "level-critical"
              : alert.fall_level === "ì¤‘ìœ„í—˜"
              ? "level-warning"
              : "level-safe";
          return `
        <div class="alert-card ${levelClass}">
          <div class="alert-meta">${alert.formatted_time}</div>
          <div class="alert-title">${alert.message}</div>
          <div class="alert-meta">
            ${alert.name} Â· ${alert.room_number} Â· ${alert.fall_level}
          </div>
        </div>
      `;
        })
      .join("");
  }

  const sse = new EventSource("{% url 'fall_alert_stream' %}");
  sse.onmessage = function (event) {
    const data = JSON.parse(event.data);
    const ts = new Date(data.timestamp);
    alerts.unshift({
      ...data,
      formatted_time: ts.toLocaleString("ko-KR", {
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
      }),
    });
    if (alerts.length > 4) {
      alerts.pop();
    }
    renderAlerts();
  };

  sse.onerror = function (err) {
    console.error("SSE ì—°ê²° ì‹¤íŒ¨:", err);
    sse.close();
  };
</script>
{% endblock %}
